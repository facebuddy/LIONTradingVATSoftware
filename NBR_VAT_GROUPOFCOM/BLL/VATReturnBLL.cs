using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Linq;
using System.Web;
using System.Web.SessionState;
namespace NBR_VAT_GROUPOFCOM.BLL
{
    public class VATReturnBLL
    {
        private DBUtility DBUtil = new DBUtility();

        public VATReturnBLL()
        {
        }

        public DataTable fillMonthAndYear()
        {
            return this.DBUtil.GetDataTable("select * from fiscal_year");
        }

        public DataTable fillOrgInfo(int orgId)
        {
            string str = string.Concat("select organization_name, business_address, factory_address, head_office_address, owner_permanent_address, registration_no from org_registration_info where organization_id = ", orgId);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillPartyName()
        {
            int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            string str = string.Concat("select party_id, party_name, party_bin, party_address, phone, email, web from trns_party where is_deleted = false and organization_id=", num);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillPartyNameforSearch(DateTime fDate, DateTime tDate)
        {
            int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            object[] str = new object[] { "select distinct tp.party_id, tp.party_name from trns_party tp \r\n                         inner join trns_purchase_master tpm on tp.party_id=tpm.party_id\r\n                        inner join trns_purchase_detail tpd on tpd.challan_id=tpm.challan_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n                        where tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false and tp.is_deleted = false\r\n                        and ttd.vds_certificate_no is not null\r\n                        and tp.organization_id=", num, " and ttd.vds_certificate_date >=to_date('", fDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and  ttd.vds_certificate_date <=to_date('", tDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')" };
            string str1 = string.Concat(str);
            return this.DBUtil.GetDataTable(str1);
        }

        public DataTable fillReportPart3(string fDate, string tDate)
        {
            string[] strArrays = new string[] { "select coalesce(sum(d.Quantity*d.actual_price),0) as price, coalesce(sum(d.Vat),0) as Vat, coalesce(sum(d.sd),0) as sd, \r\n                            d.is_inexplicit_export as deemed_export, d.is_exempted, m.trans_type,d.real_property\r\n                            from trns_sale_detail as d\r\n                            inner join trns_sale_master as m\r\n                            on d.challan_id = m.challan_id\r\n                            where d.date_insert >= '", fDate, "' AND d.date_insert <= '", tDate, "' AND d.is_deleted = false group by d.is_inexplicit_export,d.is_exempted,m.trans_type,d.real_property " };
            string str = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillReportPart4(string fDate, string tDate)
        {
            string[] strArrays = new string[] { "select\r\n\t                    case when is_source_tax_deduct=true then sum(d.Quantity*d.purchase_unit_price-d.vds_amount)\r\n\t                          when is_source_tax_deduct=false then sum(d.Quantity*d.purchase_unit_price) end  price, \r\n\t                    case when is_source_tax_deduct=true then 0\r\n\t                         when is_source_tax_deduct=false then sum(d.purchase_vat) end Vat, \r\n\t                          d.is_exempted, m.purchase_type,d.real_property,zero_rate\r\n                                            from trns_purchase_detail d\r\n                                            inner join trns_purchase_master m\r\n                                            on d.challan_id = m.challan_id\r\n                                            where d.date_insert >= '", fDate, "' AND d.date_insert <= '", tDate, "' AND d.is_deleted = false \r\n                                            group by d.is_exempted,m.purchase_type,d.real_property,zero_rate,is_source_tax_deduct" };
            string str = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillReportPart5(string fDate, string tDate)
        {
            string[] strArrays = new string[] { "select coalesce(sum(vds_amount),0) as vds,\r\n                        (select case when sum(tpd.purchase_vat) is null then 0 else sum(tpd.purchase_vat) end as rebatable_amount\r\n                        from trns_purchase_detail as tpd\r\n                        inner join trns_purchase_master as tpm \r\n                        on tpd.challan_id = tpm.challan_id\r\n                        where tpd.is_rebatable = true and tpm.payment_method = '1' and (tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) >100000\r\n                        and tpd.date_insert >= '", fDate, "' and tpd.date_insert<= '", tDate, "'),\r\n                        (select case when sum(return_vat+return_sd) is null then 0 else sum(return_vat+return_sd) end as return_amount\r\n                        from trns_note_detail where Status = 'P' and date_insert >= '", fDate, "' and date_insert<= '", tDate, "'),\r\n                        (select coalesce(sum(total_price),0) from trns_note_detail as tnd\r\n                            inner join trns_note_master as tnm\r\n                            on tnd.note_id = tnm.note_id\r\n                            where tnd.date_insert >= '", fDate, "' and tnd.date_insert <= '", tDate, "' \r\n                                  and tnm.note_type = 'D' and tnd.Status = 'O') as other_tax\r\n                        from trns_purchase_detail\r\n                        where date_insert >= '", fDate, "' and date_insert<= '", tDate, "' AND is_deleted = false" };
            string str = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillReportPart6(string fDate, string tDate)
        {
            string[] strArrays = new string[] { "select coalesce(sum(tsd.vds_amount),0) as vds_amount,\r\n                        (select coalesce(sum(tnd.return_vat),0) as return_vat from trns_note_detail as tnd inner join trns_note_master as tnm on tnd.note_id = tnm.note_id  \r\n                        where tnm.note_type = 'C' and  tnd.date_insert >= '", fDate, "' and tnd.date_insert <= '", tDate, "' ),\r\n                        (select coalesce(sum(tnd.return_sd),0) as return_sd from trns_note_detail as tnd inner join trns_note_master as tnm on tnd.note_id = tnm.note_id  \r\n                        where tnm.note_type = 'C' and  tnd.date_insert >= '", fDate, "' and tnd.date_insert <= '", tDate, "' ),\r\n                        (select coalesce(sum(total_price),0) from trns_note_detail as tnd\r\n                            inner join trns_note_master as tnm\r\n                            on tnd.note_id = tnm.note_id\r\n                            where tnd.date_insert >= '", fDate, "' and tnd.date_insert <= '", tDate, "' \r\n                                  and tnm.note_type = 'C' and tnd.Status = 'O') as other_tax\r\n                        from trns_sale_detail as tsd\r\n                        where tsd.is_source_tax_deduct = true and tsd.date_insert >= '", fDate, "' and tsd.date_insert <= '", tDate, "' AND tsd.is_deleted = false" };
            string str = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillReportPart7(string fDate, string tDate)
        {
            string[] strArrays = new string[] { "select coalesce(sum(tpd.at),0) as at\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd\r\n                        on tpd.challan_id = tpm.challan_id\r\n                        where tpm.bl_no <> '' and tpd.date_insert >= '", fDate, "' and tpd.date_insert<= '", tDate, "' AND tpd.is_deleted = false and ait_refund_status = true" };
            string str = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillVDSCertificatenoforSearch(int partyId, DateTime fDate, DateTime tDate)
        {
            int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            object[] objArray = new object[] { "select distinct ttd.vds_certificate_no from trns_treasury_detail ttd                    \r\n                         inner join  trns_purchase_master tpm on  tpm.challan_id=ttd.purchase_challan_id\r\n                        inner join trns_purchase_detail tpd on tpd.challan_id=tpm.challan_id\r\n                        inner join trns_party tp on tp.party_id=tpm.party_id\r\n                        where tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false and tp.is_deleted = false\r\n                        and ttd.vds_certificate_no is not null\r\n                        and tp.organization_id=", num, " and tp.party_id=", partyId, " and ttd.vds_certificate_date >=to_date('", fDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and  ttd.vds_certificate_date <=to_date('", tDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') " };
            string str = string.Concat(objArray);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable fillYear()
        {
            return this.DBUtil.GetDataTable("select * from fiscal_year WHERE fiscal_id = (select COALESCE(MAX(fiscal_id)) from fiscal_year)");
        }

        public DataTable getChallanNoByParty(int partyId)
        {
            string str = string.Concat("select distinct ttc.challan_id trChallanID,ttc.date_challan trChallanDate,tsm.challan_id,tsm.challan_no from trns_purchase_master tsm \r\n               inner join trns_purchase_detail tsd  on tsm.challan_id=tsd.challan_id\r\n               inner join trns_treasury_detail ttd on  tsm.challan_id=ttd.purchase_challan_id\r\n               inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n               where party_id=", partyId, " and tsd.is_source_tax_deduct=true and ttd.vds_certificate_no is null");
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getChallnDate(string challan_no)
        {
            int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            int num1 = Convert.ToInt32(HttpContext.Current.Session["ORGBRANCHID"].ToString());
            object[] challanNo = new object[] { "select tsm.date_challan\r\n                        --,ttc.code_no \r\n                        from trns_sale_master tsm\r\n                        --inner join trns_treasury_detail ttd on ttd.purchase_challan_id = tsm.challan_id\r\n                       -- inner join trns_treasury_challan ttc on ttd.tr_challan_id = ttc.challan_id\r\n                        where tsm.challan_no = '", challan_no, "' and tsm.organization_id = ", num, " and tsm.org_branch_reg_id = ", num1 };
            string str = string.Concat(challanNo);
            return this.DBUtil.GetDataTable(str);
        }

        public string GetDesignation(int did)
        {
            string empty = string.Empty;
            try
            {
                string str = string.Concat("select designation_name from admn_designation where is_deleted = false and designation_id = ", did);
                object singleValue = this.DBUtil.GetSingleValue(str);
                if (singleValue != null)
                {
                    empty = Convert.ToString(singleValue);
                }
            }
            catch (Exception exception)
            {
                throw new Exception(exception.ToString());
            }
            return empty;
        }

        public DataTable getEmployeeDetail(short empID)
        {
            string str = string.Concat("select e.employee_name, e.mobile_no, e.email, d.designation_name\r\n                        from admn_employee as e\r\n                        inner join admn_designation as d\r\n                        on d.designation_id = e.designation_id\r\n                        where e.employee_id = ", empID);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getMonthClosingInfo(string fromDate, string toDate)
        {
            int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            object[] objArray = new object[] { "select transec_id\r\n                        from month_closing_history  where CAST(closing_date_1st as Date)>=to_date('", fromDate, "','dd/MM/yyyy') \r\n                       and CAST(closing_date_2nd as Date)<=to_date('", toDate, "','dd/MM/yyyy')  and note_no=1 and organization_id=", num };
            string str = string.Concat(objArray);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getReceivableVDS(string challan_no)
        {
            string[] challanNo = new string[] { "Select string_agg(id::text, ',') AS serials, tsm.total_bill_amount as total_price,  tsm.total_vds, \r\n                        (tsm.cash_amount+tsm.bank_amount\r\n                        +COALESCE((select SUM(payment_amount) from credit_transac_history where challan_no='", challan_no, "'),0)) as paid_amount,\r\n                        Round(SUM(vds_amount)) AS vat,\r\n                        COALESCE((select SUM(vds_amount) from trns_sale_vds_detail where sale_challan_no='", challan_no, "' and is_rcv_vds=true),0 )received_vds\r\n                        from trns_sale_vds_detail tsvd\r\n                        inner join trns_sale_master tsm on tsvd.sale_challan_id=tsm.challan_id\r\n                        where tsvd.sale_challan_no='", challan_no, "' and tsvd.is_rcv_vds=false\r\n                        GROUP BY tsm.total_bill_amount, tsm.cash_amount, tsm.bank_amount, tsm.total_vds;" };
            string str = string.Concat(challanNo);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getTRChallanInfobyChallnNo(int challanNo)
        {
            string str = string.Concat("select ttd.trns_treasury_detail_id,ttc.challan_id trChallanID,ttc.date_challan trChallanDate\r\n                           from trns_treasury_challan ttc\r\n                           inner join trns_treasury_detail ttd on  ttd.tr_challan_id = ttc.challan_id \r\n                           where ttd.purchase_challan_id='", challanNo, "' and ttc.vds_certificate_no is null");
            return this.DBUtil.GetDataTable(str);
        }

        public string getVatOperationCode(int orgID)
        {
            string str = string.Concat("select com.comm_code,com.comm_id,com.comm_name\r\n                                from vat_commissionerate as com\r\n                                left join vat_division as div\r\n                                on div.comm_id = com.comm_id\r\n                                left join vat_circle as cir\r\n                                on div.division_id = cir.division_id\r\n                                left join vat_area as ar\r\n                                on cir.circle_id = ar.circle_id\r\n\t\t\t\tleft join org_registration_info as i\r\n\t\t\t\ton i.area_id = ar.area_id\r\n\t\t\t\twhere i.organization_id = ", orgID, " and com.is_deleted = false");
            return Convert.ToString(this.DBUtil.GetSingleValue(str));
        }

        public DataTable getVDSData(DateTime fDate, DateTime tDate, string challan, long partyId, int branchID)
        {
            string str = HttpContext.Current.Session["ORGANIZATION_ID"].ToString();
            string str1 = "";
            string str2 = "";
            string str3 = "";
            if (challan != "-99")
            {
                str1 = string.Concat(" AND tpm.challan_no = '", challan, "' ");
            }
            if (partyId != (long)0)
            {
                str2 = string.Concat(" AND tpm.party_id = ", partyId, " ");
            }
            string[] strArrays = new string[] { "select ttd.trns_treasury_detail_id,tp.party_id,tp.party_name ||', '|| tp.party_address party, tp.party_bin,(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) as total_amount,\r\n       to_char(tpm.date_challan,'dd/MM/yyyy') as challan_date, case when tpd.vds_amount = 0 then tpd.purchase_vat else tpd.vds_amount end  vds_amount,\r\n       i.hs_code_suffix hs_code,ttc.tr_challan_no,tpd.remarks,\r\n       tpm.transaction_type,tpm.challan_id,tpm.challan_no, tpd.purchase_unit_price,tpd.purchase_vat, tpd.purchase_sd, i.item_name,(tpd.purchase_vat+tpd.purchase_sd) as total_vat\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd on tpm.challan_id = tpd.challan_id \r\n                        inner join item as i on i.item_id = tpd.item_id\r\n                        inner join trns_party tp  on tp.party_id = tpm.party_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n                        inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n                        where tpm.date_challan >=to_date('", fDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and  tpm.date_challan <=to_date('", tDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') \r\n                        AND tpm.organization_id = ", str, " and tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false ", str1, " ", str2, " and ttd.vds_certificate_no is not null order by tpm.date_challan" };
            str3 = string.Concat(strArrays);
            return this.DBUtil.GetDataTable(str3);
        }

        public DataTable getVDSDatabyParty(int partyId)
        {
            string str = HttpContext.Current.Session["ORGANIZATION_ID"].ToString();
            string str1 = "";
            object[] objArray = new object[] { "select tp.party_id,(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) as total_amount,\r\n       to_char(tpm.date_challan,'dd/MM/yyyy') as challan_date, ttd.amount  vds_amount,\r\n--case when tpd.vds_amount = 0 then tpd.purchase_vat else tpd.vds_amount end  vds_amount,\r\n       \r\n   ttd.trns_treasury_detail_id, ttc.date_challan trdate,   tpm.challan_id,tpm.challan_no,  i.item_name,(tpd.purchase_vat) as total_vat\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd on tpm.challan_id = tpd.challan_id \r\n                        inner join item as i on i.item_id = tpd.item_id\r\n                        inner join trns_party tp  on tp.party_id = tpm.party_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n                        inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n                        where  tpm.organization_id = ", str, " and tpd.is_source_tax_deduct = true and tpd.is_deleted = false \r\n                        AND tpd.vds_status = false  and tp.party_id = ", partyId, " and ttd.vds_certificate_no is null order by tpm.date_challan" };
            str1 = string.Concat(objArray);
            return this.DBUtil.GetDataTable(str1);
        }

        public DataTable getVDSDataByPartyChallan(int challan, long partyId)
        {
            string str = "";
            object[] objArray = new object[] { "   select distinct tp.party_name  party, tp.party_bin,(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) as total_amount,\r\n       to_char(tpm.date_challan,'dd/MM/yyyy') as challan_date, \r\n       --case when tpd.vds_amount = 0 then tpd.purchase_vat else tpd.vds_amount end  vds_amount,\r\n       ttc.amount vds_amount,coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0) amount,\r\ncase when  tpm.credit_amount=0 then coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0) else cth.payment_amount end pamount,\r\n       CONCAT (TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99'),'(',case when  tpm.credit_amount=0 then TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99') else TO_CHAR(CAST(cth.payment_amount as decimal(18,2)), '9,99,99,999.99') end,')'  )price\r\n       ,i.hs_code_suffix hs_code,ttc.tr_challan_no,tpd.remarks,to_char(ttc.vds_certificate_date,'dd/MM/yyyy') issue_date,ttc.tr_challan_no,to_char(ttc.date_challan,'dd/MM/yyyy') trchallanDate,set_bank_branch.branch_name,sb.bank_name,ttc.vds_certificate_no,\r\n       tpm.transaction_type,tpm.challan_no, tpd.purchase_unit_price,tpd.purchase_vat, tpd.purchase_sd, i.item_name,(tpd.purchase_vat+tpd.purchase_sd) as total_vat\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd on tpm.challan_id = tpd.challan_id \r\n                        inner join item as i on i.item_id = tpd.item_id\r\n                        inner join trns_party tp  on tp.party_id = tpm.party_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n               inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n                        left join credit_transac_history cth on cth.challan_id=tpm.challan_id\r\n                        inner join set_bank_branch on ttc.branch_id=set_bank_branch.branch_id\r\n                        inner join set_bank sb on sb.bank_id= set_bank_branch.bank_id \r\n where tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false  AND tpm.challan_id = ", challan, "   AND tpm.party_id =", partyId, " and ttd.vds_certificate_no is not null" };
            str = string.Concat(objArray);
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getVDSDataByPartyChallanForRpt(string certificate, long partyId)
        {
            string str = "";
            if (certificate == "---SELECT---")
            {
                str = string.Concat("   select  tp.party_name  party, tp.party_bin,(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) as total_amount,\r\n       to_char(tpm.date_challan,'dd/MM/yyyy') as challan_date, \r\n       --case when tpd.vds_amount = 0 then tpd.purchase_vat else tpd.vds_amount end  vds_amount,\r\n       ttd.amount vds_amount,coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0) amount,\r\n       case when  tpm.credit_amount=0 then coalesce(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd,0) else cth.payment_amount end pamount,\r\n       CONCAT (TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99'),'(',case when  tpm.credit_amount=0 then TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99') else TO_CHAR(CAST(cth.payment_amount as decimal(18,2)), '9,99,99,999.99') end,')'  )price\r\n       ,i.hs_code_suffix hs_code,ttc.tr_challan_no,tpd.remarks,to_char(ttd.vds_certificate_date,'dd/MM/yyyy') issue_date,\r\n       ttc.tr_challan_no,to_char(ttc.date_challan,'dd/MM/yyyy') trchallanDate,set_bank_branch.branch_name,sb.bank_name,ttd.vds_certificate_no,\r\n       tpm.transaction_type,tpm.challan_no, tpd.purchase_unit_price,tpd.purchase_vat, tpd.purchase_sd, i.item_name,(tpd.purchase_vat+tpd.purchase_sd) as total_vat\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd on tpm.challan_id = tpd.challan_id \r\n                        inner join item as i on i.item_id = tpd.item_id\r\n                        inner join trns_party tp  on tp.party_id = tpm.party_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n                        inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n                        left join credit_transac_history cth on cth.scroll_id=ttd.scroll_id\r\n                        inner join set_bank_branch on ttc.branch_id=set_bank_branch.branch_id\r\n                        inner join set_bank sb on sb.bank_id= set_bank_branch.bank_id \r\n                        where tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false  AND tpm.party_id =", partyId, " and  ttd.vds_certificate_no is not null ");
            }
            else
            {
                object[] objArray = new object[] { "   select  tp.party_name  party, tp.party_bin,(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd) as total_amount,\r\n       to_char(tpm.date_challan,'dd/MM/yyyy') as challan_date,tpm.challan_id ,tpd.item_id,\r\n       --case when tpd.vds_amount = 0 then tpd.purchase_vat else tpd.vds_amount end  vds_amount,\r\n       ttd.amount vds_amount,coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0) amount,\r\n       case when  tpm.credit_amount=0 then coalesce(tpd.Quantity* tpd.purchase_unit_price+tpd.purchase_vat+tpd.purchase_sd,0) else cth.payment_amount end pamount,\r\n       CONCAT (TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99'),'(',case when  tpm.credit_amount=0 then TO_CHAR(CAST(coalesce(tpd.quantity,0)*coalesce(tpd.purchase_unit_price,0)as decimal(18,2)), '9,99,99,999.99') else TO_CHAR(CAST(cth.payment_amount as decimal(18,2)), '9,99,99,999.99') end,')'  )price\r\n       ,i.hs_code_suffix hs_code,ttc.tr_challan_no,tpd.remarks,to_char(ttd.vds_certificate_date,'dd/MM/yyyy') issue_date,\r\n       ttc.tr_challan_no,to_char(ttc.date_challan,'dd/MM/yyyy') trchallanDate,set_bank_branch.branch_name,sb.bank_name,ttd.vds_certificate_no,\r\n       tpm.transaction_type,tpm.challan_no, tpd.purchase_unit_price,tpd.purchase_vat, tpd.purchase_sd, i.item_name,(tpd.purchase_vat) as total_vat\r\n                        from trns_purchase_master as tpm\r\n                        inner join trns_purchase_detail as tpd on tpm.challan_id = tpd.challan_id \r\n                        inner join item as i on i.item_id = tpd.item_id\r\n                        inner join trns_party tp  on tp.party_id = tpm.party_id\r\n                        inner join trns_treasury_detail ttd on  tpm.challan_id=ttd.purchase_challan_id\r\n                        inner join trns_treasury_challan ttc on  ttd.tr_challan_id = ttc.challan_id\r\n                        left join credit_transac_history cth on cth.scroll_id=ttd.scroll_id\r\n                        inner join set_bank_branch on ttc.branch_id=set_bank_branch.branch_id\r\n                        inner join set_bank sb on sb.bank_id= set_bank_branch.bank_id \r\n                        where tpd.is_source_tax_deduct = true and tpd.is_deleted = false AND tpd.vds_status = false  AND tpm.party_id =", partyId, " and \r\n                       ttd.vds_certificate_no='", certificate, "'" };
                str = string.Concat(objArray);
            }
            return this.DBUtil.GetDataTable(str);
        }

        public DataTable getVDSReceiveData(string challan_no)
        {
            string[] challanNo = new string[] { "select ic.category_name as sub_category_name, i.item_name as item, i.item_id, i.hs_code,iu.unit_code, tsd.Quantity, tsd.actual_price, \r\n                        (tsd.Quantity*tsd.actual_price+tsd.sd+tsd.Vat) as total_price,\r\n                            --(tsd.sd+tsd.Vat)as Vat,\r\n                            tsd.Vat as Vat,\r\n                        (select category_name as category from item_category \r\n                        where category_id = \r\n                        (select  max(ic.parent_id) \r\n                        from trns_sale_detail as tsd\r\n                        inner join trns_sale_master as tsm\r\n                        on tsd.challan_id = tsm.challan_id \r\n                        inner join item as i \r\n                        on i.item_id = tsd.item_id\r\n                        inner join item_category as ic\r\n                        on ic.category_id = i.sub_category_id\r\n                        where tsm.challan_no = '", challan_no, "')) \r\n                        from trns_sale_detail as tsd\r\n                        join item as i\r\n                        on i.item_id = tsd.item_id\r\n                        inner join item_unit as iu\r\n                        on iu.unit_id = tsd.unit_id\r\n                        inner join item_category as ic\r\n                        on ic.category_id = i.sub_category_id\r\n                        where challan_id = (select challan_id from trns_sale_master where challan_no = '", challan_no, "' limit 1) AND is_source_tax_deduct = true " };
            string str = string.Concat(challanNo);
            return this.DBUtil.GetDataTable(str);
        }

        public bool insertMontClosingBalance(List<MonthClosingBalance> objMCBList, DateTime fromdate, DateTime todate)
        {
            bool flag = false;
            try
            {
                ArrayList arrayLists = new ArrayList();
                int num = Convert.ToInt32(this.DBUtil.GetSingleValue("SELECT  nextval('transec_id_seq')"));
                int num1 = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
                foreach (MonthClosingBalance monthClosingBalance in objMCBList)
                {
                    int num2 = Convert.ToInt32(this.DBUtil.GetSingleValue("SELECT  nextval('closing_id')"));
                    monthClosingBalance.fromdate = fromdate;
                    monthClosingBalance.todate = todate;
                    object[] str = new object[] { "insert into month_closing_history (closing_id,organization_id,closing_date_1st,closing_date_2nd,credit_amount,debit_amount,vat_amount,sd_amount,note_no,transec_id) values\r\n            (", num2, ",", num1, ",TO_DATE('", monthClosingBalance.fromdate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy'),TO_DATE('", monthClosingBalance.todate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy'),", monthClosingBalance.Credit_amount, ",", monthClosingBalance.Debit_amount, ",", monthClosingBalance.Vat_amount, ",", monthClosingBalance.Sd_amount, ",", monthClosingBalance.Noteno, ",", num, ")" };
                    arrayLists.Add(string.Concat(str));
                }
                flag = this.DBUtil.ExecuteBatchDML(arrayLists);
            }
            catch (Exception exception1)
            {
                Exception exception = exception1;
                StackTrace stackTrace = new StackTrace(exception, true);
                StackFrame frame = stackTrace.GetFrame(stackTrace.FrameCount - 1);
                int fileLineNumber = frame.GetFileLineNumber();
                Utility.InsertErrorTrackNew(exception.Message, "insertMontClosingBalance.aspx", "ShowReport", fileLineNumber);
            }
            return flag;
        }

        public DataTable rptVATReturn(DateTime fromDate, DateTime toDate, short organizationId)
        {
            object[] str = new object[] { "select coalesce(sum(d.sale_price),0) sale_price,coalesce(sum(d.sale_sd),0) sale_sd,coalesce(sum(d.sale_vat),0) sale_vat,\r\n            coalesce(sum(d.sale_exmp),0) sale_exmp,coalesce(sum(sale_exmp_sd),0)sale_exmp_sd,coalesce(sum(sale_exmp_vat),0)sale_exmp_vat,\r\n            coalesce(sum(d.exmp_item_sale),0) exmp_item_sale,coalesce(sum(d.other_adjustment),0) other_adjustment,coalesce(sum(d.purchase_value),0) purchase_value,\r\n            coalesce(sum(d.rebatable_tax),0) rebatable_tax,cast(coalesce(sum(d.purchase_value_import),0) as decimal) purchase_value_import,\r\n            coalesce(sum(d.rebatable_tax_import),0) rebatable_tax_import,sum(d.rebate_on_export) rebate_on_export,coalesce(sum(d.purchase),0) purchase,\r\n            coalesce(sum(d.other_adj_purchase),0) other_adj_purchase,\r\n            coalesce(sum(pre_m_cls_b),0) pre_m_cls_b,coalesce(sum(d.treasury_deposit),0) treasury_deposit,coalesce(sum(return_tax_office),0) return_tax_office,\r\n            coalesce(sum(d.ts_tax_deduct),0) ts_tax_deduct, coalesce(sum(d.vds_amount),0) vds_amount_19,\r\n            coalesce(sum(credit_balance),0) credit_balance,coalesce(sum(credit_vat),0) credit_vat,coalesce(sum(credit_sd),0) credit_sd\r\n            from (\r\n            /*1*/\r\n            select sum(tsd.actual_price*Quantity)sale_price,sum(tsd.Sd) sale_sd, case when tsd.is_source_tax_deduct = true then 0 else sum(tsd.Vat) end sale_vat, --sum(tsd.Vat) sale_vat,\r\n                    0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,\r\n            0 other_adjustment,0 purchase_value, 0 rebatable_tax,0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,\r\n            0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct , 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd      \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(tsm.date_challan) >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and Date(date_challan) <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " --and tsd.is_source_tax_deduct = false\r\n            group by tsd.is_source_tax_deduct\r\n\r\n            /*2*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,sum(tsd.actual_price*Quantity) sale_exmp,sum(tsd.Sd) sale_exmp_sd,sum(tsd.Vat) sale_exmp_vat,0 exmp_item_sale,\r\n            0 other_adjustment,0 purchase_value, 0 rebatable_tax,0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,\r\n            0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct , 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd       \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(tsm.date_challan) >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and Date(date_challan) <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and ((tsd.Sd =0 and tsd.Vat =0 and tsm.trans_type = 'L') or tsm.trans_type = 'E')\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n            /*3*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,sum(tsd.actual_price*Quantity) exmp_item_sale,0 other_adjustment,\r\n            0 purchase_value, 0 rebatable_tax,0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export , 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd      \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(tsm.date_challan) >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and Date(date_challan) <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = true and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n\r\n/*5 start*/\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,coalesce(sum(d.other_adj) ,0) other_adjustment,\r\n            0 purchase_value, 0 rebatable_tax,0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from (\r\n                    select coalesce(sum(tsd.Vat),0) other_adj\r\n                    from trns_sale_detail tsd\r\n                    inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n                    where tsm.challan_type = 'S' and Date(tsm.date_challan) >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and Date(tsm.date_challan) <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n                    and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n                union all\r\n                    select coalesce(sum(tnd.total_vat),0) other_adj \r\n                    from trns_note_detail tnd \r\n                    inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n                    where tnm.date_note >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and tnm.date_note <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            \r\n/* Commit 17/08/2017*/\r\n/*   union all\r\n                    select coalesce(ttc.Amount,0) other_adj \r\n                     from trns_treasury_challan ttc\r\n                    where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7) and \r\n                    ttc.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and ttc.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and ttc.Organization_id = ", organizationId, " */\r\n                union all\r\n                    select \r\n                    case when tpd.is_rebatable = true then sum(tpd.purchase_vat)+ sum(tpd.purchase_sd) else 0 end  other_adj\r\n                    from trns_purchase_detail tpd\r\n                    inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n                    inner join Item i on i.Item_id = tpd.Item_id\r\n                    where tpm.challan_type = 'P' and tpm.date_challan >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n                    and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n                    and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n                    group by tpd.is_rebatable\r\n            )d\r\n/*5 End*/\r\n            /*7*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,coalesce(sum(tpd.quantity*tpd.purchase_unit_price),0) purchase_value,\r\n            case when tpd.is_rebatable = true then sum(tpd.purchase_vat)+ sum(tpd.purchase_sd) else 0 end rebatable_tax, 0 purchase_value_import,0 rebatable_tax_import,0 purchase,\r\n            0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct   , 0 rebate_on_export , 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd   \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\n            group by tpd.is_rebatable\r\n   union all\r\n/*No Need This Query*/\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,coalesce(sum(tpd.quantity*tpd.purchase_unit_price),0) purchase_value,\r\n           coalesce(sum(tpd.purchase_sd+tpd.purchase_vat),0)*( coalesce(sum(i.vat_rebate),0) /100)  rebatable_tax, 0 purchase_value_import,0 rebatable_tax_import,0 purchase,\r\n            0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct   , 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n\r\n            /*8*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            coalesce(sum(tpd.quantity*tpd.purchase_unit_price),0) purchase_value_import,\r\n            case when tpd.is_rebatable = true then sum(tpd.purchase_vat)+ sum(tpd.purchase_sd) else 0 end rebatable_tax_import,\r\n            0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct  , 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9*/\r\n\t        union all\r\n\t   \r\n           select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value, 0 rebatable_tax,\r\n            0 purchase_value_import, 0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,0 ts_tax_deduct , \r\n            sum(tsd.Vat)+ sum(tsd.Sd) rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd       \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(tsm.date_challan) >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and Date(date_challan) <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n            /*10*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,coalesce(sum(tpd.quantity*tpd.purchase_unit_price),0) purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' AND tpd.is_exempted = true and tpm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tpm.Organization_id = ", organizationId, "\r\n\r\n            /*12*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,coalesce(sum(tpd.Ait),0) other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,\r\n            0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,sum(tnd.total_vat) other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tnm.date_note <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n /*union all\r\n             \r\n\t    select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,sum(tpd.purchase_sd)+ sum(tpd.purchase_vat) other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,\r\n            0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan >=   to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') \r\n            and tpm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n*/\r\n\r\n            /*13*/\r\n/*\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax, \r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,sum(d.exempt_amount-d.payment_amount) pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from \r\n            ( \r\n            select sum(tpd.Sd+tpd.Vat) exempt_amount,0 payment_amount \r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id where tpm.Is_deleted = false and tpd.Is_deleted = false \r\n            and tpm.challan_type = 'P'\r\n            and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tpm.Organization_id = ", organizationId, " \r\n            and ((tpm.purchase_type = 'L' and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false)) or\r\n            (tpm.purchase_type = 'I' and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true)))\r\n            union all\r\n            select coalesce(sum(ttc.Amount),0) exempt_amount,0 payment_amount from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 1 and ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and ttc.Organization_id = ", organizationId, "\r\n            union all\r\n            select sum(tnd.rbt_vat-tnd.dif_vat) exempt_amount,0 payment_amount\r\n            from trns_note_detail tnd\r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select 0 exempt_amount,sum(tsd.Vat) payment_amount\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type in ('L','E') and tsm.Organization_id = ", organizationId, "\r\n            and tsm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            union all\r\n            select 0 exempt_amount, sum(tpd.Sd+tpd.Vat) payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and ((tpm.purchase_type = 'L' and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true) )or\r\n            (tpm.purchase_type = 'I' and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false))) and tpm.Organization_id = ", organizationId, "\r\n            union all\r\n            select 0 exempt_amount,sum(tnd.rbt_vat-tnd.dif_vat) payment_amount\r\n            from trns_note_detail tnd\r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            )d\r\n*/\r\n\r\n union all\r\n /*13*/\r\n           \r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax, \r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,sum(d.exempt_amount-d.payment_amount) pre_m_cls_b,0 treasury_deposit,\r\n            0 return_tax_office,0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from (\r\n\r\n /*1  sale_sd + sale_vat*/\r\n\r\n select 0 exempt_amount, sum(tsd.Sd) + sum(tsd.Vat) payment_amount\r\n  from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n             and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " \r\n\r\n/*16 treasury_deposit*/\r\n            union all\r\n            select \r\n           coalesce(sum(ttc.Amount),0) exempt_amount,  0 payment_amount\r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false  and ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            --and ttc.chalan_type_d = 1 \r\n            and ttc.Organization_id = ", organizationId, " \r\n\r\n            union all\r\n             /*5 other_adj*/\r\n            select 0 exempt_amount, coalesce(sum(d.other_adj) ,0) payment_amount \r\n            from ( \r\n           \r\n            select coalesce(sum(tsd.Vat),0) other_adj\r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' and Date(tsm.date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(sum(tnd.total_vat),0) other_adj \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(ttc.Amount,0) other_adj from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7) and \r\n            ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and ttc.Organization_id = ", organizationId, " \r\n union all\r\n select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end  other_adj\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n            group by tpd.is_rebatable\r\n)d\r\n\r\n\r\n /*12 other_adj_purchase*/\r\n           /*union all\r\n            select \r\n           coalesce(sum(tpd.Atv),0) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            */\r\n union all\r\n            select \r\n           sum(tnd.rbt_vat)+ sum(tnd.rbt_other_tax) exempt_amount, 0 payment_amount\r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n             \r\n\t    select \r\n           sum(-tpd.Sd)+ sum(-tpd.Vat) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n \r\n/*7 rebatable_tax*/\r\n union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\n            group by tpd.is_rebatable\r\n             union all\r\n            select \r\n           coalesce(sum(tpd.Sd+tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100)  exempt_amount, 0 payment_amount\r\n             from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n\r\n             /*8 rebatable_tax_import*/\r\n            union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9 rebate_on_export*/\r\n\t        union all\r\n\t   \r\n           select \r\n           sum(tsd.Vat)+ sum(tsd.Sd) exempt_amount , 0 payment_amount     \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n\r\n) d\r\n\r\n            /*16*/\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,coalesce(sum(ttc.Amount),0) treasury_deposit,0 return_tax_office,\r\n            0 ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd     \r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy') and ttc.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            --and ttc.chalan_type_d = 1 \r\n            and ttc.Organization_id = ", organizationId, " \r\n\r\n            /*19*/\r\n\r\n            /*\r\n            union all\r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax, 0 vds_amount,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,\r\n            coalesce(sum(tsd.Vat),0) ts_tax_deduct, 0 rebate_on_export,0 credit_balance,0 credit_vat,0 credit_sd     \r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' and tsd.is_source_tax_deduct = true and tsm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')  and tsm.Organization_id = ", organizationId, "\r\n            */\r\n            union all\r\n            \r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,\r\n            coalesce(sum(tsd.Vat),0) ts_tax_deduct, 0 rebate_on_export, 0 vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tsd \r\n            inner join trns_purchase_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'P' and tsd.is_source_tax_deduct = true and tsm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')  and tsm.Organization_id = ", organizationId, "\r\n\r\nunion all\r\n            \r\n            select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit,0 return_tax_office,\r\n            0 ts_tax_deduct, 0 rebate_on_export,coalesce(sum(tsd.vds_amount),0) vds_amount,0 credit_balance,0 credit_vat,0 credit_sd    \r\n            from trns_purchase_detail tsd \r\n            inner join trns_purchase_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'P' and tsd.is_source_tax_deduct = true and tsm.date_challan >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tsm.date_challan <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')  and tsm.Organization_id = ", organizationId, "\r\n\r\nUNION ALL\r\n\r\n\t   select 0 sale_price,0 sale_sd,0 sale_vat,0 sale_exmp,0 sale_exmp_sd,0 sale_exmp_vat,0 exmp_item_sale,0 other_adjustment,0 purchase_value,0 rebatable_tax,\r\n            0 purchase_value_import,0 rebatable_tax_import,0 purchase,0 other_adj_purchase,0 pre_m_cls_b,0 treasury_deposit, 0 return_tax_office,0 ts_tax_deduct, \r\n            0 rebate_on_export, 0 vds_amount,coalesce(SUM(tnd.quantity*tnd.unit_price),0) credit_balance,coalesce(SUM(return_vat),0) credit_vat, coalesce(SUM(return_sd),0) credit_sd   \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')  and tnm.date_note <=  to_date('", toDate.ToString("dd/MM/yyyy"), "','MM/dd/yyyy')\r\n            and tnm.note_type = 'C' and tnd.status='S'  and tnm.Organization_id = ", organizationId, "\r\n           \r\n\r\n) d " };
            string str1 = string.Concat(str);
            return this.DBUtil.GetDataTable(str1);
        }

        public bool saveDataFromVatReturnReport(VatReturnDAO objVatReturnDAO, string fDate, string tDate)
        {
            ArrayList arrayLists = new ArrayList();
            objVatReturnDAO.ReportId = Convert.ToInt64(this.DBUtil.GetSingleValue("SELECT  nextval('report_id_seq')"));
            objVatReturnDAO.CgNo = Convert.ToInt16(this.DBUtil.GetSingleValue(string.Concat("SELECT coalesce(max(cg_no),0)+1 from vat_return group by vat_report_year having vat_report_year = '", objVatReturnDAO.Year, "'")));
            object[] reportId = new object[] { "INSERT INTO vat_return(\r\n            report_id, organization_id, vat_term, rules_64, rules_66, rules_67, \r\n            past_tp_activities, date_insert, deemed_export_n1, direct_export_n2, \r\n            exempt_supply_n3, ts_amount_n4, ts_vat_n4, ts_sd_n4, bls_amount_n5, \r\n            bls_vat_n5, tv_p3_n6, ep_local_n7, ep_import_n8, spl_amount_n9, \r\n            spl_vat_n9, spi_amount_n10, spi_vat_n10, blp_amount_n11, blp_vat_n11, \r\n            tv_p4_n12, vds_n13, non_banking_n14, change_purchase_n15, other_adjusment_n16, \r\n            increase_adjusment_n17, vds_n18, change_sale_n19, sd_n20, other_adjusment_n21, \r\n            decrease_adjusment_n22, vat_sd_n23, musok18_n24, da_n25, advance_vat_n26, \r\n            negative_amount_n27, excise_duty_n28, surcharges_n29, total_vat_n30, \r\n            excise_duty_n31, surcharges_n32, carry_forward_n33, cash_back_n33, \r\n            refund_amount_n33, duty_officer_name, duty_officer_designation, \r\n            report_entry_date, duty_officer_mobile, duty_officer_email, cg_no,vat_report_year)\r\n    VALUES (", objVatReturnDAO.ReportId, ", ", objVatReturnDAO.OrgId, ", '", objVatReturnDAO.VatTerm, "', ", objVatReturnDAO.Rules64, ", ", objVatReturnDAO.Rules66, ", ", objVatReturnDAO.Rules67, ", \r\n            ", objVatReturnDAO.PastTaxPeriod, ",to_timestamp('", objVatReturnDAO.InsertDate.ToString("MM/dd/yyyy HH:mm"), "','MM/dd/yyyy HH24:MI'), ", objVatReturnDAO.DeemedExportN1, ", ", objVatReturnDAO.DirectExportN2, ", \r\n            ", objVatReturnDAO.ExemptSupplyN3, ", ", objVatReturnDAO.TypicalSupplyAmountN4, ", ", objVatReturnDAO.TypicalSupplyVatN4, ", ", objVatReturnDAO.TypicalSupplySDN4, ", ", objVatReturnDAO.BLSupplyAmountN5, ", \r\n            ", objVatReturnDAO.BLSupplyVatN5, ", ", objVatReturnDAO.TotalVatP3N6, ", ", objVatReturnDAO.ExemptLocalPurchaseN7, ", ", objVatReturnDAO.ExemptPurchaseImportN8, ", ", objVatReturnDAO.StandardLocalPurchaseAmountN9, ", \r\n            ", objVatReturnDAO.StandardLocalPurchaseVatN9, ", ", objVatReturnDAO.StandardPurchaseImportAmountN10, ", ", objVatReturnDAO.StandardPurchaseImportVatN10, ", ", objVatReturnDAO.BLPurchaseAmountN11, ", ", objVatReturnDAO.BLPurchaseVatN11, ", \r\n            ", objVatReturnDAO.TotalVatP4N12, ", ", objVatReturnDAO.IncreaseVDSAmountN13, ", ", objVatReturnDAO.NonBankingAmountN14, ", ", objVatReturnDAO.ChangePurchaseAmountN15, ", ", objVatReturnDAO.IncreaseOtherAdjusmentN16, ", \r\n            ", objVatReturnDAO.TotalIncreaseAdjusmentN17, ", ", objVatReturnDAO.DecreaseVDSAmountN18, ", ", objVatReturnDAO.ChangeSaleAmountN19, ", ", objVatReturnDAO.DecreaseSDAmountN20, ", ", objVatReturnDAO.DecreaseOtherAdjusmentN21, ", \r\n            ", objVatReturnDAO.TotalDecreaseAdjusmentN22, ", ", objVatReturnDAO.TotalVatSDN23, ", ", objVatReturnDAO.Mushok18N24, ", ", objVatReturnDAO.DecreaseAmountN25, ", ", objVatReturnDAO.AdvanceTaxN26, ", \r\n            ", objVatReturnDAO.NegativeAmountN27, ", ", objVatReturnDAO.ExciseDutyP7N28, ", ", objVatReturnDAO.SurechargeP7N29, ", ", objVatReturnDAO.TotalVatN30, ", \r\n            ", objVatReturnDAO.ExciseDutyP8N31, ", ", objVatReturnDAO.SurechargeP8N32, ", ", objVatReturnDAO.CarryForwordN33, ", ", objVatReturnDAO.CashBackN33, ", \r\n            ", objVatReturnDAO.RefundAmountN33, ", '", objVatReturnDAO.DutyOfficerName, "', '", objVatReturnDAO.DutyOfficerDesignation, "', \r\n            to_timestamp('", objVatReturnDAO.ReportEntryDate.ToString("MM/dd/yyyy HH:mm"), "','MM/dd/yyyy HH24:MI'), '", objVatReturnDAO.DutyOfficerMobile, "', '", objVatReturnDAO.DutyOfficerEmail, "', ", objVatReturnDAO.CgNo, ", '", objVatReturnDAO.Year, "')" };
            arrayLists.Add(string.Concat(reportId));
            string[] str = new string[] { "update trns_purchase_detail set return_date =  to_timestamp('", null, null, null, null, null, null };
            str[1] = objVatReturnDAO.ReportEntryDate.ToString("MM/dd/yyyy HH:mm");
            str[2] = "','MM/dd/yyyy HH24:MI') where date_insert >= '";
            str[3] = fDate;
            str[4] = "' AND date_insert <= '";
            str[5] = tDate;
            str[6] = "'";
            arrayLists.Add(string.Concat(str));
            string[] strArrays = new string[] { "update trns_sale_detail set return_date =  to_timestamp('", null, null, null, null, null, null };
            strArrays[1] = objVatReturnDAO.ReportEntryDate.ToString("MM/dd/yyyy HH:mm");
            strArrays[2] = "','MM/dd/yyyy HH24:MI') where date_insert >= '";
            strArrays[3] = fDate;
            strArrays[4] = "' AND date_insert <= '";
            strArrays[5] = tDate;
            strArrays[6] = "'";
            arrayLists.Add(string.Concat(strArrays));
            string[] str1 = new string[] { "update trns_note_detail set return_date =  to_timestamp('", null, null, null, null, null, null };
            str1[1] = objVatReturnDAO.ReportEntryDate.ToString("MM/dd/yyyy HH:mm");
            str1[2] = "','MM/dd/yyyy HH24:MI') where date_insert >= '";
            str1[3] = fDate;
            str1[4] = "' AND date_insert <= '";
            str1[5] = tDate;
            str1[6] = "' and Status='O'";
            arrayLists.Add(string.Concat(str1));
            return this.DBUtil.ExecuteBatchDML(arrayLists);
        }

        public bool updateMontClosingBalance(List<MonthClosingBalance> objMCBList, DateTime fromdate, DateTime todate, int transecId)
        {
            bool flag = false;
            try
            {
                ArrayList arrayLists = new ArrayList();
                int num = Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
                foreach (MonthClosingBalance monthClosingBalance in objMCBList)
                {
                    monthClosingBalance.fromdate = fromdate;
                    monthClosingBalance.todate = todate;
                    object[] str = new object[] { "Update  month_closing_history set closing_date_1st =TO_DATE('", monthClosingBalance.fromdate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy') ,closing_date_2nd = TO_DATE('", monthClosingBalance.todate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n                    ,credit_amount= ", monthClosingBalance.Credit_amount, ", debit_amount = ", monthClosingBalance.Debit_amount, ", vat_amount=", monthClosingBalance.Vat_amount, ",sd_amount=", monthClosingBalance.Sd_amount, " ,organization_id=", num, "\r\n                    where note_no=", monthClosingBalance.Noteno, " and transec_id =", transecId };
                    arrayLists.Add(string.Concat(str));
                }
                flag = this.DBUtil.ExecuteBatchDML(arrayLists);
            }
            catch (Exception exception1)
            {
                Exception exception = exception1;
                StackTrace stackTrace = new StackTrace(exception, true);
                StackFrame frame = stackTrace.GetFrame(stackTrace.FrameCount - 1);
                int fileLineNumber = frame.GetFileLineNumber();
                Utility.InsertErrorTrackNew(exception.Message, "insertMontClosingBalance.aspx", "ShowReport", fileLineNumber);
            }
            return flag;
        }

        public bool updateRcvVDS(string ids, string certificate, string challan_no, string accountCode, DateTime vdsCertificateDate, DateTime taxDepoDate, string taxSerial, DateTime rcvDate)
        {
            ArrayList arrayLists = new ArrayList();
            string[] strArrays = ids.Split(new char[] { ',' });
            for (int i = 0; i < strArrays.Count<string>(); i++)
            {
                string[] str = new string[] { "update trns_sale_vds_detail\r\n                        set is_rcv_vds=true, rcv_vds_date= to_timestamp('", rcvDate.ToString("dd/MM/yyyy HH:mm"), "','dd/MM/yyyy HH24:MI') ,\r\n                        vds_certificate_no = '", certificate, "',\r\n                        account_code='", accountCode, "',\r\n                        vds_certificate_date=to_timestamp('", vdsCertificateDate.ToString("dd/MM/yyyy HH:mm"), "','dd/MM/yyyy HH24:MI'),\r\n                        tax_depo_date=to_timestamp('", taxDepoDate.ToString("dd/MM/yyyy HH:mm"), "','dd/MM/yyyy HH24:MI'),\r\n                        tax_depo_serial_no = '", taxSerial, "'\r\n                        where id=", strArrays[i], " AND sale_challan_no = '", challan_no, "' and is_deleted = false" };
                arrayLists.Add(string.Concat(str));
            }
            return this.DBUtil.ExecuteBatchDML(arrayLists);
        }

        public bool updateVDS(double amount, string certificate, string challan_no, string accountCode, DateTime vdsCertificateDate)
        {
            object[] objArray = new object[] { "update trns_sale_detail\r\n                        set vds_amount = ", amount, ", vds_certificate_no = '", certificate, "',account_code='", accountCode, "',vds_certificate_date=to_timestamp('", vdsCertificateDate.ToString("dd/MM/yyyy HH:mm"), "','dd/MM/yyyy HH24:MI')\r\n                        where challan_id = (select challan_id from trns_sale_master where challan_no = '", challan_no, "' limit 1) and is_source_tax_deduct = true and is_deleted = false" };
            string str = string.Concat(objArray);
            return this.DBUtil.ExecuteDML(str);
        }

        public bool updateVDSForIssue(string certificate, int challan_id, DateTime challanDate, string challanNo)
        {
            ArrayList arrayLists = new ArrayList();
            Convert.ToInt32(HttpContext.Current.Session["organization_id"]);
            object[] objArray = new object[] { "update trns_treasury_detail\r\n                        set  vds_certificate_no = '", certificate, "'\r\n                        , vds_certificate_date=to_timestamp('", challanDate.ToString("dd/MM/yyyy HH:mm"), "','dd/MM/yyyy HH24:MI') \r\n                        where trns_treasury_detail_id = ", challan_id };
            arrayLists.Add(string.Concat(objArray));
            arrayLists.Add(string.Concat("update trns_challan_no_detail set is_used=true where challan_no='", certificate, "' "));
            return this.DBUtil.ExecuteBatchDML(arrayLists);
        }
    }
}
