using Npgsql;
using System;
using System.Data;
using System.Data.Common;

namespace NBR_VAT_GROUPOFCOM.BLL
{

    public class CurrentAccountBLL
    {
        private DBUtility DBUtil = new DBUtility();

        public CurrentAccountBLL()
        {
        }

        public DataTable GetCurrentAccount18ReportBySearch(DateTime fromDate, DateTime toDate, short organizationId)
        {
            object[] str = new object[] { "select to_char(Date(d.date_challan),'dd-MON-yyyy') date_challan,d.trns_desc,d.challan_no,d.tresury_deposit treasury_deposit,d.exempt_amount,d.pay_amount,d.others,d.balance_amount,d.balance_action from (\r\n            /*B/F*/\r\n            select to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') date_challan,'B/F' trns_desc,'' challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,0 others,sum(d.exempt_amount-d.payment_amount) balance_amount,0 balance_action , '' Remarks\r\n            from ( \r\n/*\r\nselect sum(tpd.Sd+tpd.Vat) exempt_amount,0 payment_amount from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id  \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P'\r\n            and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tpm.Organization_id = ", organizationId, "\r\n            and ((tpm.purchase_type = 'L' and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false)) or\r\n            (tpm.purchase_type = 'I' and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true)))\r\n            union all\r\n            select coalesce(sum(ttc.Amount),0) exempt_amount,0 payment_amount from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, "\r\n            union all\r\n            select sum(tnd.rbt_vat-tnd.dif_vat) exempt_amount,0 payment_amount from trns_note_detail tnd\r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select 0 exempt_amount,sum(tsd.Vat) payment_amount from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type in ('L','E') and tsm.Organization_id = ", organizationId, "\r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            union all\r\n            select 0 exempt_amount, sum(tpd.Sd+tpd.Vat) payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and ((tpm.purchase_type = 'L' and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true) ) or\r\n            (tpm.purchase_type = 'I' and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false))) and tpm.Organization_id = ", organizationId, "\r\n            union all\r\n            select 0 exempt_amount,sum(tnd.rbt_vat-tnd.dif_vat) payment_amount\r\n            from trns_note_detail tnd\r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            */\r\n\r\n\r\n /*1  sale_sd + sale_vat*/\r\n\r\n select 0 exempt_amount, sum(tsd.Sd) + sum(tsd.Vat) payment_amount\r\n  from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n             and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " \r\n\r\n/*16 treasury_deposit*/\r\n            union all\r\n            select \r\n           coalesce(sum(ttc.Amount),0) exempt_amount,  0 payment_amount\r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false  and ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and ttc.chalan_type_d = 1 and ttc.Organization_id = ", organizationId, " \r\n\r\n            union all\r\n             /*5 other_adj*/\r\n            select 0 exempt_amount, coalesce(sum(d.other_adj) ,0) payment_amount \r\n            from ( \r\n           \r\n            select coalesce(sum(tsd.Vat),0) other_adj\r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' and Date(tsm.date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(sum(tnd.dif_other_tax+tnd.dif_vat),0) other_adj \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('01/02/2013','dd/MM/yyyy') and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(ttc.Amount,0) other_adj from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7) and \r\n            ttc.date_challan < to_date('01/02/2013','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, " \r\n union all\r\n select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end  other_adj\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n            group by tpd.is_rebatable\r\n)d\r\n\r\n\r\n /*12 other_adj_purchase*/\r\n            union all\r\n            select \r\n           coalesce(sum(tpd.Atv),0) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n            select \r\n           sum(tnd.rbt_vat)+ sum(tnd.rbt_other_tax) exempt_amount, 0 payment_amount\r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n             \r\n\t    select \r\n           sum(-tpd.Sd)+ sum(-tpd.Vat) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n \r\n/*7 rebatable_tax*/\r\n union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n             inner join Item i on i.Item_id = tpd.Item_id\r\nwhere tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\ngroup by tpd.is_rebatable\r\n             union all\r\n            select \r\n           coalesce(sum(tpd.Sd+tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100)  exempt_amount, 0 payment_amount\r\n             from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n\r\n             /*8 rebatable_tax_import*/\r\n            union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat)+ sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9 rebate_on_export*/\r\n\t        union all\r\n\t   \r\n           select \r\n           sum(tsd.Vat)+ sum(tsd.Sd) exempt_amount , 0 payment_amount     \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n\r\n)d\r\n            union all\r\n            /*SALE-LOCAL*/\r\n            select tsm.date_challan,'Sale (Local)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Sd) +sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = false and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n             HAVING sum(tsd.Sd) + sum(tsd.Vat) > 0 \r\n\r\nunion all\r\n            /*VDS Adjustment*/\r\n            select tsm.date_challan,'VDS Adjustment' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(tsd.Sd) +sum(tsd.Vat) others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n             HAVING sum(tsd.Sd) + sum(tsd.Vat) > 0 \r\n\r\n            --union all\r\n            /*SALE-LOCAL -- VDS*/\r\n           -- select tsm.date_challan,'VDS' trns_desc,tsm.challan_no,sum(tsd.Sd) +sum(tsd.Vat) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n           -- from trns_sale_detail tsd \r\n            --inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n           -- where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n           -- and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n           -- group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n           --  HAVING sum(tsd.Sd) + sum(tsd.Vat) > 0 \r\n\r\n\r\n            /*SALE-EXPORT*/ -- Deducted By Ruhul Bhai\r\n            union all\r\n            select tsm.date_challan,'Sale (Export)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Sd) +sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'E' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tsd.is_source_tax_deduct = TRUE and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            /*PURCHASE-LOCAL*/\r\n            /*union all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Sd+tpd.Vat) pay_amount,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') \r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n--union all\r\n\r\n\r\n /*New Comment Out For New Logic*/\r\n--            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,coalesce(sum(tpd.Sd+tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100) exempt_amount,sum(tpd.Sd+tpd.Vat) pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n--            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n--             inner join Item i on i.Item_id = tpd.Item_id\r\n--            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n--            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n--            and i.item_type in ( 'U', 'S')\r\n--            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n--            /*PURCHASE-LOCAL-EXEMP*/\r\n--            union all\r\n--            select tpm.date_challan,'Purchase(Local)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Sd+tpd.Vat) exempt_amount,0 pay_amount,0 others,0 balance_amount,1 balance_action, tpm.Remarks\r\n--            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n--            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n--            and (/*tpd.is_source_tax_deduct = true or*/ tpd.is_exempted = true ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n--            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n--having  sum(tpd.Sd+tpd.Vat) > 0\r\n            /*PURCHASE-IMPORT*/\r\n           /* union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, \r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Sd+tpd.Vat) pay_amount,0 balance_amount,1 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n\r\nunion all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n             sum(tpd.Sd+tpd.Vat)  exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') and tpd.is_rebatable = true\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks\r\n\r\n            /*PURCHASE-IMPORT-EXEMP*/\r\n            union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Sd+tpd.Vat) exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true or tpd.is_REBATABLE= true ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n            /*TREASURY DEPOSIT*/ --(2,4,5,8)\r\n            union all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 8\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(ttc.Amount) others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 5\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 4\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 2\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 6\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 1\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\n             /*FINE*/\r\n            --union all\r\n            --select ttc.date_challan,'Fine' trns_desc,ttc.challan_no,0 tresury_deposit,0 exempt_amount,sum(ttc.Amount) pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            --from trns_treasury_challan ttc\r\n            --where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 3 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, "\r\n            --group by ttc.date_challan,ttc.challan_no, ttc.Remarks\r\n/*SALE RETURN D/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(D/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,0 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no\r\n            /*SALE_RETURN C/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,1 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no ) d order by d.date_challan,d.trns_desc\r\n            --------------------------------------------------------------------------\r\nunion all\r\n            select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,tnd.return_vat + tnd.return_sd others,0 balance_amount,0 balance_action, '' Remarks\r\n            from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            group by tnm.date_note,tnm.note_no,tnd.return_vat,tnd.return_sd \r\n             HAVING sum(tnd.return_vat) + sum(tnd.return_sd) > 0 ) d order by d.date_challan,d.trns_desc " };
            string str1 = string.Concat(str);
            return this.DBUtil.GetDataTable(str1);
        }

        public DataTable GetCurrentAccount18ReportBySearchSD(DateTime fromDate, DateTime toDate, short organizationId)
        {
            object[] str = new object[] { "select to_char(Date(d.date_challan),'dd-MON-yyyy') date_challan,d.trns_desc,d.challan_no,cast(d.tresury_deposit as decimal(20,2)) treasury_deposit,d.exempt_amount,d.pay_amount,d.others,d.balance_amount,d.balance_action from (\r\n            /*B/F*/\r\n            select to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') date_challan,'B/F' trns_desc,'' challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,0 others,sum(d.exempt_amount-d.payment_amount) balance_amount,0 balance_action , '' Remarks\r\n            from ( \r\n\r\n\r\n\r\n /*1  sale_sd + sale_vat*/\r\n\r\n select 0 exempt_amount, sum(tsd.Sd) payment_amount\r\n  from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n             and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " \r\n\r\n/*16 treasury_deposit*/\r\n            union all\r\n            select \r\n           coalesce(sum(ttc.Amount),0) exempt_amount,  0 payment_amount\r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false  and ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and ttc.chalan_type_d = 1 and ttc.Organization_id = ", organizationId, " \r\n\r\n            union all\r\n             /*5 other_adj*/\r\n            select 0 exempt_amount, coalesce(sum(d.other_adj) ,0) payment_amount \r\n            from ( \r\n           \r\n            select coalesce(sum(tsd.Vat),0) other_adj\r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' and Date(tsm.date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(sum(tnd.dif_other_tax+tnd.dif_vat),0) other_adj \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('01/02/2013','dd/MM/yyyy') and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            --union all\r\n           -- select coalesce(ttc.Amount,0) other_adj from trns_treasury_challan ttc\r\n           -- where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7) and \r\n           -- ttc.date_challan < to_date('01/02/2013','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, " \r\n union all\r\n select \r\n            case when tpd.is_rebatable = true then sum(tpd.Sd) else 0 end  other_adj\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n            group by tpd.is_rebatable\r\n)d\r\n\r\n\r\n /*12 other_adj_purchase*/\r\n            union all\r\n            select \r\n           coalesce(sum(tpd.Atv),0) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n            select \r\n           sum(tnd.rbt_vat)+ sum(tnd.rbt_other_tax) exempt_amount, 0 payment_amount\r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n             \r\n\t    select \r\n           sum(-tpd.Sd) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n \r\n/*7 rebatable_tax*/\r\n union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n             inner join Item i on i.Item_id = tpd.Item_id\r\nwhere tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\ngroup by tpd.is_rebatable\r\n             union all\r\n            select \r\n            coalesce(sum(tpd.Sd),0)*( coalesce(sum(i.vat_rebate),0) /100)  exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n            \r\n             /*8 rebatable_tax_import*/\r\n            union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Sd) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9 rebate_on_export*/\r\n\t        union all\r\n\t   \r\n            select \r\n            sum(tsd.Sd) exempt_amount , 0 payment_amount     \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n            and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n\r\n)d\r\n            union all\r\n            /*SALE-LOCAL*/\r\n            select tsm.date_challan,'Sale (Local)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,\r\n            sum(tsd.Sd)  pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = false and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Sd) > 0 \r\n\r\nunion all\r\n            /*VDS Adjustment*/\r\n            select tsm.date_challan,'VDS Adjustment' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(tsd.Sd) others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Sd) > 0 \r\n\r\n            --union all\r\n           \r\n\r\n\r\n            /*SALE-EXPORT*/ -- Deducted By Ruhul Bhai\r\n            union all\r\n            select tsm.date_challan,'Sale (Export)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Sd) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'E' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tsd.is_source_tax_deduct = TRUE and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            /*PURCHASE-LOCAL*/\r\n            /*union all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Sd) pay_amount,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') \r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n--union all\r\n\r\n\r\n\r\n            /*PURCHASE-IMPORT*/\r\n           /* union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, \r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Sd) pay_amount,0 balance_amount,1 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n\r\nunion all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n             sum(tpd.Sd)  exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') and tpd.is_rebatable = true\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks\r\n            HAVING sum(tpd.Sd) > 0\r\n\r\n            /*PURCHASE-IMPORT-EXEMP*/\r\n            union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Sd) exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true or tpd.is_REBATABLE= true ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n            HAVING sum(tpd.Sd) > 0\r\n            \r\n            /*TREASURY DEPOSIT*/ --(9,10,11,12,13,14)\r\n            union all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 9\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 10\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(ttc.Amount) others,0 balance_amount,1 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 11\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(ttc.Amount) others,0 balance_amount,1 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 12\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 13\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\n union all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 14\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n             /*FINE*/\r\n            --union all\r\n            --select ttc.date_challan,'Fine' trns_desc,ttc.challan_no,0 tresury_deposit,0 exempt_amount,sum(ttc.Amount) pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            --from trns_treasury_challan ttc\r\n            --where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 3 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, "\r\n            --group by ttc.date_challan,ttc.challan_no, ttc.Remarks\r\n/*SALE RETURN D/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(D/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,0 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no\r\n            /*SALE_RETURN C/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,1 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no ) d order by d.date_challan,d.trns_desc\r\n            --------------------------------------------------------------------------\r\nunion all\r\n            select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,tnd.return_sd others,0 balance_amount,0 balance_action, '' Remarks\r\n            from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            group by tnm.date_note,tnm.note_no,tnd.return_vat,tnd.return_sd \r\n            HAVING sum(tnd.return_vat) + sum(tnd.return_sd) > 0 ) d order by d.date_challan,d.trns_desc " };
            string str1 = string.Concat(str);
            return this.DBUtil.GetDataTable(str1);
        }

        public DataTable GetCurrentAccount18ReportBySearchVAT(DateTime fromDate, DateTime toDate, short organizationId)
        {
            object[] str = new object[] { "select to_char(Date(d.date_challan),'dd-MON-yyyy') date_challan,d.trns_desc,d.challan_no,cast(d.tresury_deposit as decimal(20,2)) treasury_deposit,d.exempt_amount,d.pay_amount,d.others,d.balance_amount,d.balance_action from (\r\n            /*B/F*/\r\n            select to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') date_challan,'B/F' trns_desc,'' challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,0 others,sum(d.exempt_amount-d.payment_amount) balance_amount,0 balance_action , '' Remarks\r\n            from ( \r\n\r\n\r\n\r\n /*1  sale_sd + sale_vat*/\r\n\r\n select 0 exempt_amount, sum(tsd.Vat) payment_amount\r\n  from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n             and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " \r\n\r\n/*16 treasury_deposit*/\r\n            union all\r\n            select \r\n           coalesce(sum(ttc.Amount),0) exempt_amount,  0 payment_amount\r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false  and ttc.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and ttc.chalan_type_d = 1 and ttc.Organization_id = ", organizationId, " \r\n\r\n            union all\r\n             /*5 other_adj*/\r\n            select 0 exempt_amount, coalesce(sum(d.other_adj) ,0) payment_amount \r\n            from ( \r\n           \r\n            select coalesce(sum(tsd.Vat),0) other_adj\r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' and Date(tsm.date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(sum(tnd.dif_other_tax+tnd.dif_vat),0) other_adj \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('01/02/2013','dd/MM/yyyy') and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(ttc.Amount,0) other_adj from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7) and \r\n            ttc.date_challan < to_date('01/02/2013','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, " \r\n union all\r\n select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end  other_adj\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n            group by tpd.is_rebatable\r\n)d\r\n\r\n\r\n /*12 other_adj_purchase*/\r\n            union all\r\n            select \r\n           coalesce(sum(tpd.Atv),0) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n            select \r\n           sum(tnd.rbt_vat) + sum(tnd.rbt_other_tax) exempt_amount, 0 payment_amount\r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where tnm.date_note < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n             \r\n\t    select \r\n            sum(-tpd.Vat) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  \r\n        group by tpd.is_rebatable\r\n\r\n \r\n/*7 rebatable_tax*/\r\n union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P'  and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\ngroup by tpd.is_rebatable\r\n             union all\r\n            select \r\n           coalesce(sum(tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100)  exempt_amount, 0 payment_amount\r\n             from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n\r\n             /*8 rebatable_tax_import*/\r\n            union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' and tpm.date_challan < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9 rebate_on_export*/\r\n\t        union all\r\n\t   \r\n           select \r\n           sum(tsd.Vat) exempt_amount , 0 payment_amount     \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and Date(date_challan) < to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n\r\n)d\r\n            union all\r\n            /*SALE-LOCAL*/\r\n            select tsm.date_challan,'Sale (Local)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = false and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Vat) > 0 \r\n\r\nunion all\r\n            /*VDS Adjustment*/\r\n            select tsm.date_challan,'VDS Adjustment' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(tsd.Vat) others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Vat) > 0 \r\n\r\n            --union all\r\n            /*SALE-LOCAL -- VDS*/\r\n           -- select tsm.date_challan,'VDS' trns_desc,tsm.challan_no,sum(tsd.Vat) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n           -- from trns_sale_detail tsd \r\n            --inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n           -- where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n           -- and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n           -- group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n           --  HAVING  sum(tsd.Vat) > 0 \r\n\r\n\r\n            /*SALE-EXPORT*/ -- Deducted By Ruhul Bhai\r\n            union all\r\n            select tsm.date_challan,'Sale (Export)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'E' \r\n            and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tsm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tsd.is_source_tax_deduct = TRUE and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            /*PURCHASE-LOCAL*/\r\n            /*union all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Vat) pay_amount,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') \r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n--union all\r\n\r\n\r\n /*New Comment Out For New Logic*/\r\n--            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,coalesce(sum(tpd.Sd+tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100) exempt_amount,sum(tpd.Sd+tpd.Vat) pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n--            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n--             inner join Item i on i.Item_id = tpd.Item_id\r\n--            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n--            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n--            and i.item_type in ( 'U', 'S')\r\n--            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n--            /*PURCHASE-LOCAL-EXEMP*/\r\n--            union all\r\n--            select tpm.date_challan,'Purchase(Local)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Sd+tpd.Vat) exempt_amount,0 pay_amount,0 others,0 balance_amount,1 balance_action, tpm.Remarks\r\n--            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n--            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n--            and (/*tpd.is_source_tax_deduct = true or*/ tpd.is_exempted = true ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n--            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n--having  sum(tpd.Sd+tpd.Vat) > 0\r\n            /*PURCHASE-IMPORT*/\r\n           /* union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, \r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Vat) pay_amount,0 balance_amount,1 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n\r\nunion all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n             sum(tpd.Vat)  exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >=  to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            and i.item_type in ( 'I') and tpd.is_rebatable = true\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks\r\n\r\n            /*PURCHASE-IMPORT-EXEMP*/\r\n            union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Vat) exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true or tpd.is_REBATABLE= true ) and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tpm.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy')\r\n            group by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n            /*TREASURY DEPOSIT*/ --(1 - 8)\r\n            union all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 8\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(ttc.Amount) others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 5\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 4\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 2\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 6\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 1\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 3\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 7\r\n            --and ttc.chalan_type_d = 1 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            --and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','dd/MM/yyyy') \r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            AND TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("MM/dd/yyyy"), "','MM/dd/yyyy')\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\n\r\n\r\n             /*FINE*/\r\n            --union all\r\n            --select ttc.date_challan,'Fine' trns_desc,ttc.challan_no,0 tresury_deposit,0 exempt_amount,sum(ttc.Amount) pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            --from trns_treasury_challan ttc\r\n            --where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 3 and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(ttc.date_challan, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and ttc.Organization_id = ", organizationId, "\r\n            --group by ttc.date_challan,ttc.challan_no, ttc.Remarks\r\n/*SALE RETURN D/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(D/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,0 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no\r\n            /*SALE_RETURN C/N*/\r\n            --union all\r\n            --select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,0 tresury_deposit,sum(tnd.rbt_vat-tnd.dif_vat)+ sum(tnd.rbt_other_tax) exempt_amount,0 pay_amount,0 balance_amount,1 balance_action, '' Remarks\r\n            --from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            --where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            --group by tnm.date_note,tnm.note_no ) d order by d.date_challan,d.trns_desc\r\n            --------------------------------------------------------------------------\r\nunion all\r\n            select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,\r\n            tnd.return_vat others,0 balance_amount,0 balance_action, '' Remarks\r\n            from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            group by tnm.date_note,tnm.note_no,tnd.return_vat,tnd.return_sd \r\n            HAVING sum(tnd.return_vat) > 0 \r\nunion all\r\n            select tnm.date_note date_challan,'Purchase Return(D/N)' trns_desc,tnm.note_no challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,\r\n            tnd.return_vat others,0 balance_amount,0 balance_action, '' Remarks\r\n            from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false \r\n            and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  >= to_date('", fromDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') \r\n            and TO_DATE(TO_CHAR(tnm.date_note, 'MM/dd/yyyy'), 'MM/dd/yyyy')  <= to_date('", toDate.ToString("dd/MM/yyyy"), "','dd/MM/yyyy') \r\n            and tnm.note_type = 'D' and tnm.Organization_id = ", organizationId, "\r\n            group by tnm.date_note,tnm.note_no,tnd.return_vat,tnd.return_sd \r\n            HAVING sum(tnd.return_vat) > 0 \r\n) d order by d.date_challan,d.trns_desc " };
            string str1 = string.Concat(str);
            return this.DBUtil.GetDataTable(str1);
        }

        public DataTable GetLastUpdatedBalanceVAT(short organizationId)
        {
            object[] objArray = new object[] { "select to_char(Date(d.date_challan),'dd-MON-yyyy') date_challan,d.trns_desc,d.challan_no,d.tresury_deposit treasury_deposit,d.exempt_amount,d.pay_amount,d.others,d.balance_amount,d.balance_action from (\r\n            /*B/F*/\r\n            select to_date('01/01/2010','dd/MM/yyyy') date_challan,'B/F' trns_desc,'' challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,0 others,sum(d.exempt_amount-d.payment_amount) balance_amount,0 balance_action , '' Remarks\r\n            from ( \r\n\r\n\r\n\r\n /*1  sale_sd + sale_vat*/\r\n\r\n select 0 exempt_amount, sum(tsd.Vat) payment_amount\r\n  from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n            and tsd.is_source_tax_deduct = false and tsd.is_exempted = false and (tsd.Sd >0 or tsd.Vat > 0) and tsm.trans_type = 'L'\r\n            and tsm.Organization_id = ", organizationId, " \r\n\r\n/*16 treasury_deposit*/\r\n            union all\r\n            select \r\n           coalesce(sum(ttc.Amount),0) exempt_amount,  0 payment_amount\r\n            from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false  \r\n            \r\n            and ttc.chalan_type_d = 1 and ttc.Organization_id = ", organizationId, " \r\n\r\n            union all\r\n             /*5 other_adj*/\r\n            select 0 exempt_amount, coalesce(sum(d.other_adj) ,0) payment_amount \r\n            from ( \r\n           \r\n            select coalesce(sum(tsd.Vat),0) other_adj\r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id and tsm.Is_deleted = false\r\n            where tsm.challan_type = 'S' \r\n            \r\n            and tsd.is_source_tax_deduct = true  and tsm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(sum(tnd.dif_other_tax+tnd.dif_vat),0) other_adj \r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            and tnm.note_type = 'D'  and tnm.Organization_id = ", organizationId, "\r\n            union all\r\n            select coalesce(ttc.Amount,0) other_adj from trns_treasury_challan ttc\r\n            where ttc.Is_deleted = false and ttc.chalan_type_d in (2,3,4,5,6,7)  \r\n            and ttc.Organization_id = ", organizationId, " \r\n union all\r\n select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end  other_adj\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' \r\n            \r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  and i.item_type in ( 'S','U') and tpd.is_rebatable = true\r\n            group by tpd.is_rebatable\r\n)d\r\n\r\n\r\n /*12 other_adj_purchase*/\r\n            union all\r\n            select \r\n           coalesce(sum(tpd.Atv),0) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' \r\n            and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n            select \r\n           sum(tnd.rbt_vat) + sum(tnd.rbt_other_tax) exempt_amount, 0 payment_amount\r\n            from trns_note_detail tnd \r\n            inner join trns_note_master tnm on tnm.note_id = tnd.note_id and tnm.Is_deleted = false\r\n            where  tnm.note_type = 'C'  and tnm.Organization_id = ", organizationId, " \r\n            \r\n union all\r\n             \r\n\t    select \r\n            sum(-tpd.Vat) exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P'  \r\n            and  tpd.is_exempted = false and tpd.is_source_tax_deduct = true and tpm.Organization_id = ", organizationId, "  \r\n        group by tpd.is_rebatable\r\n\r\n \r\n/*7 rebatable_tax*/\r\n union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P'  \r\n            \r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type = 'I'\r\ngroup by tpd.is_rebatable\r\n             union all\r\n            select \r\n           coalesce(sum(tpd.Vat),0)*( coalesce(sum(i.vat_rebate),0) /100)  exempt_amount, 0 payment_amount\r\n             from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.challan_type = 'P' \r\n            \r\n            and tpm.purchase_type = 'L' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, " and i.item_type in ('S', 'U') AND tpd.is_rebatable = true \r\n\r\n             /*8 rebatable_tax_import*/\r\n            union all\r\n            select \r\n            case when tpd.is_rebatable = true then sum(tpd.Vat) else 0 end exempt_amount, 0 payment_amount\r\n            from trns_purchase_detail tpd\r\n            inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id and tpm.Is_deleted = false\r\n            where tpm.challan_type = 'P' \r\n            \r\n            and tpm.purchase_type = 'I' AND tpd.is_exempted = false and tpm.Organization_id = ", organizationId, "  group by tpd.is_rebatable\r\n\r\n            /*9 rebate_on_export*/\r\n\t        union all\r\n\t   \r\n           select \r\n           sum(tsd.Vat) exempt_amount , 0 payment_amount     \r\n            from trns_sale_detail tsd\r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.challan_type = 'S' and tsm.Is_deleted = false \r\n             and tsd.is_source_tax_deduct = false and tsd.is_exempted = false \r\n             and   tsm.trans_type = 'E'\r\n            and tsm.Organization_id = ", organizationId, "\r\n\r\n\r\n)d\r\n            union all\r\n            /*SALE-LOCAL*/\r\n            select tsm.date_challan,'Sale (Local)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            AND tsd.is_source_tax_deduct = false and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Vat) > 0 \r\n\r\nunion all\r\n            /*VDS Adjustment*/\r\n            select tsm.date_challan,'VDS Adjustment' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(tsd.Vat) others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'L' \r\n            \r\n            AND tsd.is_source_tax_deduct = true and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            HAVING sum(tsd.Vat) > 0 \r\n\r\n\r\n            /*SALE-EXPORT*/ -- Deducted By Ruhul Bhai\r\n            union all\r\n            select tsm.date_challan,'Sale (Export)' trns_desc,tsm.challan_no,0 tresury_deposit,0 exempt_amount,sum(tsd.Vat) pay_amount,0 others,0 balance_amount,1 balance_action, tsm.Remarks\r\n            from trns_sale_detail tsd \r\n            inner join trns_sale_master tsm on tsm.Challan_id = tsd.Challan_id\r\n            where tsm.Is_deleted = false and tsd.Is_deleted = false and tsm.challan_type = 'S' and tsm.trans_type = 'E' \r\n            and tsd.is_source_tax_deduct = TRUE and tsm.Organization_id = ", organizationId, "\r\n            group by tsm.date_challan,tsm.challan_no, tsm.Remarks\r\n            /*PURCHASE-LOCAL*/\r\n            /*union all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Vat) pay_amount,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) \r\n            and i.item_type in ( 'I') \r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n--union all\r\n\r\n\r\n            /*PURCHASE-IMPORT*/\r\n           /* union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, \r\n            case tpd.is_rebatable when true then sum(tpd.Sd+tpd.Vat) else 0 end exempt_amount,sum(tpd.Vat) pay_amount,0 balance_amount,1 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) \r\n            \r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks*/\r\n\r\nunion all\r\n            select tpm.date_challan,'Purchase (Local)' trns_desc,tpm.challan_no,0 tresury_deposit,\r\n             sum(tpd.Vat)  exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n             inner join Item i on i.Item_id = tpd.Item_id\r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'L' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = false or tpd.is_exempted = false ) \r\n            and i.item_type in ( 'I') and tpd.is_rebatable = true\r\n            group by tpm.date_challan,tpm.challan_no,tpd.is_rebatable, tpm.Remarks\r\n\r\n            /*PURCHASE-IMPORT-EXEMP*/\r\n            union all\r\n            select tpm.date_challan,'Purchase (Import)' trns_desc,tpm.challan_no,0 tresury_deposit, sum(tpd.Vat) exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, tpm.Remarks\r\n            from trns_purchase_detail tpd inner join trns_purchase_master tpm on tpm.Challan_id = tpd.Challan_id \r\n            where tpm.Is_deleted = false and tpd.Is_deleted = false and tpm.challan_type = 'P' and tpm.purchase_type = 'I' and tpm.Organization_id = ", organizationId, "\r\n            and (tpd.is_source_tax_deduct = true or tpd.is_exempted = true or tpd.is_REBATABLE= true ) \r\ngroup by tpm.date_challan,tpm.challan_no, tpm.Remarks\r\n\r\n            /*TREASURY DEPOSIT*/ --(1 - 8)\r\n            union all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9  and ttc.chalan_type_d = 8\r\n            --and ttc.chalan_type_d = 1 \r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,sum(ttc.Amount) others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 5\r\n            \r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 4\r\n            \r\n            \r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 2\r\n            \r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 6\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 1\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 3\r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\nunion all\r\n            select ttc.date_challan,'Treasury Deposit(' || aD.code_name || ')' AS trns_desc,\r\n            CASE\r\n            WHEN ttc.tr_challan_no = '' then ttc.challan_no\r\n    \t\telse ttc.tr_challan_no\r\n\t    \tEND challan_no,\r\n            sum(ttc.Amount) tresury_deposit,0 exempt_amount,0 pay_amount,0 others,0 balance_amount,0 balance_action, ttc.Remarks\r\n            from trns_treasury_challan ttc\r\n            LEFT JOIN app_code_detail aD ON ttc.chalan_type_m = aD.code_id_m AND ttc.chalan_type_d = aD.code_id_d \r\n            where ttc.Is_deleted = false and ttc.chalan_type_m = 9 and ttc.chalan_type_d = 7\r\n            \r\n            \r\n            and ttc.Organization_id = ", organizationId, "\r\n            group by ttc.date_challan,ttc.challan_no, ttc.Remarks,ttc.tr_challan_no,aD.code_name\r\n\r\n\r\n\r\n\r\n\r\n            --------------------------------------------------------------------------\r\nunion all\r\n            select tnm.date_note date_challan,'Sale Return(C/N)' trns_desc,tnm.note_no challan_no,\r\n            0 tresury_deposit,0 exempt_amount,0 pay_amount,\r\n            tnd.return_vat others,0 balance_amount,0 balance_action, '' Remarks\r\n            from trns_note_detail tnd inner join trns_note_master tnm on tnm.note_id = tnd.note_id\r\n            where tnm.Is_deleted = false and tnd.Is_deleted = false \r\n            and tnm.note_type = 'C' and tnm.Organization_id = ", organizationId, "\r\n            group by tnm.date_note,tnm.note_no,tnd.return_vat,tnd.return_sd \r\n            HAVING sum(tnd.return_vat) > 0 ) d order by d.date_challan,d.trns_desc " };
            string str = string.Concat(objArray);
            return this.DBUtil.GetDataTable(str);
        }

        public bool InsertBalance(int orgID, decimal vat, decimal sd, int user_id, DateTime date)
        {
            bool flag = false;
            DataTable dataTable = this.DBUtil.GetDataTable("select * from balance");
            if (dataTable == null || dataTable.Rows.Count <= 0)
            {
                object[] objArray = new object[] { "INSERT INTO balance(organization_id, vat, sd, user_id_insert) VALUES(", orgID, ",", vat, ", ", sd, ",", user_id, " ) " };
                string str = string.Concat(objArray);
                flag = this.DBUtil.ExecuteDML(str);
                return flag;
            }
            object[] objArray1 = new object[] { "UPDATE balance  SET organization_id = ", orgID, ", vat=", vat, ", sd=", sd, ", date_update=to_timestamp('", date, "','dd/MM/yyyy HH24:MI'), user_id_update= ", user_id };
            string str1 = string.Concat(objArray1);
            flag = this.DBUtil.ExecuteDML(str1);
            return flag;
        }

        //public bool InsertLicenseInfo(string orgName, string license_key, string app_version, int con_user, int service_pack)
        //{
        //    bool flag;
        //    string str = "INSERT INTO admin_license_info (  organigation_name,license_key,app_version,is_active,activation_date,concurrent_user,service_pack,user_id_insert) VALUES   ( @organigation_name , @license_key , @app_version , @is_active , now() , @concurrent_user , @service_pack, @USER_ID_INSERT )";
        //    try
        //    {
        //        try
        //        {
        //            NpgsqlCommand npgsqlCommand = new NpgsqlCommand(str, DBUtility.getDBConnection());
        //            npgsqlCommand.get_Parameters().AddWithValue("@organigation_name", orgName);
        //            npgsqlCommand.get_Parameters().AddWithValue("@license_key", license_key);
        //            npgsqlCommand.get_Parameters().AddWithValue("@app_version", app_version);
        //            npgsqlCommand.get_Parameters().AddWithValue("@is_active", true);
        //            npgsqlCommand.get_Parameters().AddWithValue("@concurrent_user", Convert.ToInt32(con_user));
        //            npgsqlCommand.get_Parameters().AddWithValue("@service_pack", service_pack);
        //            npgsqlCommand.get_Parameters().AddWithValue("@user_id_insert", Utility.GetLoggedEmployeeID());
        //            if (npgsqlCommand.ExecuteNonQuery() == 1)
        //            {
        //                flag = true;
        //                return flag;
        //            }
        //        }
        //        catch (Exception exception)
        //        {
        //            ReallySimpleLog.WriteLog(exception);
        //        }
        //        return false;
        //    }
        //    finally
        //    {
        //        DBUtility.CloseDBConnection();
        //    }
        //    return flag;
        //}
    }


}
